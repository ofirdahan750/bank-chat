<article
  class="chat-bubble"
  [class.chat-bubble--mine]="isMine"
  [class.chat-bubble--bot]="message.sender.isBot"
  [class.chat-bubble--pulse]="pulse()"
>
  @if (message.sender.id && !isMine && !message.sender.isBot) {
    <div class="chat-bubble__sender" animate.enter="anim-enter-soft">
      {{ message.sender.username }}
    </div>
  }

  @if (!isEditing()) {
    <div class="chat-bubble__content" animate.enter="anim-enter-soft">{{ message.content }}</div>

    <div class="chat-bubble__meta" animate.enter="anim-enter-soft">
      <span class="chat-bubble__time">{{ timeLabel }}</span>

      @if (message.edits?.length) {
        <button type="button" class="chat-bubble__edited" (click)="toggleHistory()">
          Edited
        </button>
      }

      @if (canEdit) {
        <button type="button" class="chat-bubble__icon" (click)="startEdit()" aria-label="Edit message">
          <mat-icon aria-hidden="true">edit</mat-icon>
        </button>
      }
    </div>

    <div class="chat-bubble__reactions" role="group" aria-label="Reactions" animate.enter="anim-enter-soft">
      @for (r of reactionOptions; track r.key) {
        <button
          type="button"
          class="chat-bubble__reaction"
          [class.chat-bubble__reaction--active]="hasReacted(r.key)"
          (click)="toggleReaction(r.key)"
          [attr.aria-label]="r.label"
        >
          <span class="chat-bubble__reaction-emoji" aria-hidden="true">{{ r.emoji }}</span>

          @if (reactionCount(r.key) > 0) {
            <span class="chat-bubble__reaction-count">{{ reactionCount(r.key) }}</span>
          }
        </button>
      }
    </div>

    @if (showHistory() && (message.edits?.length ?? 0) > 0) {
      <div
        class="chat-bubble__history"
        role="region"
        aria-label="Edit history"
        animate.enter="anim-enter-soft"
        animate.leave="anim-leave-soft"
      >
        @for (e of message.edits!; track $index) {
          <div class="chat-bubble__history-item">
            <div class="chat-bubble__history-time">{{ formatHistoryTime(e.editedAt) }}</div>
            <div class="chat-bubble__history-content">{{ e.previousContent }}</div>
          </div>
        }
      </div>
    }
  } @else {
    <form
      class="chat-bubble__edit"
      [formGroup]="editForm"
      (ngSubmit)="saveEdit()"
      animate.enter="anim-enter-soft"
      animate.leave="anim-leave-soft"
    >
      <input
        matInput
        class="app-input chat-bubble__edit-input"
        type="text"
        [attr.maxlength]="AppConfig.MAX_MSG_LENGTH"
        formControlName="content"
      />

      <div class="chat-bubble__edit-actions">
        <button
          type="submit"
          class="app-btn app-btn--primary"
          [disabled]="editForm.invalid || editForm.controls.content.value.trim() === message.content.trim()"
        >
          Save
        </button>

        <button type="button" class="app-btn app-btn--ghost" (click)="cancelEdit()">
          Cancel
        </button>
      </div>
    </form>
  }
</article>
