<section class="feature-chat">
  @if (!chatStore.hasNickname()) {
  <div
    class="feature-chat__card surface"
    role="region"
    [attr.aria-label]="UI_TEXT.A11Y.NICKNAME_REGION"
    animate.enter="anim-enter-panel"
  >
    <header class="feature-chat__header">
      <h2 class="feature-chat__title">{{ UI_TEXT.LOGIN.TITLE }}</h2>
      <p class="feature-chat__subtitle">{{ UI_TEXT.LOGIN.SUBTITLE }}</p>
    </header>

    <form
      class="feature-chat__form"
      [formGroup]="nicknameForm"
      (ngSubmit)="submitNickname()"
    >
      <label class="sr-only" [attr.for]="domIds.NICKNAME_INPUT">
        {{ UI_TEXT.A11Y.NICKNAME_INPUT_LABEL }}
      </label>

      <input
        matInput
        class="app-input feature-chat__nickname-input"
        type="text"
        autocomplete="nickname"
        [id]="domIds.NICKNAME_INPUT"
        [attr.maxlength]="chatUi.USER.MAX_USERNAME_LENGTH"
        [placeholder]="UI_TEXT.LOGIN.INPUT_PLACEHOLDER"
        [attr.aria-invalid]="
          nicknameForm.controls.username.touched &&
          nicknameForm.controls.username.invalid
        "
        [attr.aria-describedby]="
          nicknameForm.controls.username.touched &&
          nicknameForm.controls.username.invalid
            ? domIds.NICKNAME_ERROR
            : null
        "
        [formControl]="nicknameForm.controls.username"
      />

      @if (nicknameForm.controls.username.touched &&
      nicknameForm.controls.username.hasError('required')) {
      <div
        class="feature-chat__error"
        [id]="domIds.NICKNAME_ERROR"
        role="alert"
      >
        {{ UI_TEXT.LOGIN.ERROR_REQUIRED }}
      </div>
      } @else if (nicknameForm.controls.username.touched &&
      nicknameForm.controls.username.hasError('minlength')) {
      <div
        class="feature-chat__error"
        [id]="domIds.NICKNAME_ERROR"
        role="alert"
      >
        {{ UI_TEXT.LOGIN.ERROR_MIN_LENGTH }}
      </div>
      } @else if (nicknameForm.controls.username.touched &&
      nicknameForm.controls.username.hasError('maxlength')) {
      <div
        class="feature-chat__error"
        [id]="domIds.NICKNAME_ERROR"
        role="alert"
      >
        {{ UI_TEXT.LOGIN.ERROR_MAX_LENGTH }}
      </div>
      }

      <button
        class="app-btn app-btn--primary feature-chat__btn"
        type="submit"
        [disabled]="nicknameForm.invalid"
      >
        {{ UI_TEXT.LOGIN.BUTTON }}
      </button>
    </form>
  </div>
  } @else { @let me = chatStore.me();

  <div
    class="feature-chat__room surface"
    role="region"
    [attr.aria-label]="UI_TEXT.A11Y.CHAT_REGION"
    animate.enter="anim-enter-panel"
  >
    <header class="feature-chat__room-header">
      <div class="feature-chat__room-head">
        <div class="feature-chat__room-title">{{ chatStore.username() }}</div>
        <div class="feature-chat__room-subtitle">{{ config.BOT_NAME }}</div>
      </div>

      <button
        type="button"
        class="feature-chat__logout"
        (click)="logout()"
        [attr.aria-label]="UI_TEXT.A11Y.LOGOUT_BUTTON"
        [title]="UI_TEXT.A11Y.LOGOUT_BUTTON"
      >
        <mat-icon aria-hidden="true">logout</mat-icon>
      </button>
    </header>

    <div
      class="feature-chat__messages"
      role="log"
      aria-live="polite"
      aria-relevant="additions"
      [attr.aria-label]="UI_TEXT.A11Y.CHAT_LOG"
    >
      @if (chatStore.messages().length === 0) {
      <div class="feature-chat__empty" animate.enter="anim-enter-soft">
        <div>{{ UI_TEXT.CHAT.EMPTY_STATE }}</div>
      </div>
      } @else { @for (message of chatStore.messages(); track message.id) {
      <app-chat-bubble
        animate.enter="anim-enter-bubble"
        [message]="message"
        [meId]="me.id"
        [isMine]="message.sender.id === me.id && !message.sender.isBot"
        [canEdit]="message.sender.id === me.id && !message.sender.isBot"
        [timeLabel]="formatChatTime(message.timestamp)"
        (editSubmit)="onEditSubmit($event)"
        (reactionToggle)="onReactionToggle($event)"
      />
      } }
    </div>

    <form
      class="feature-chat__composer"
      [formGroup]="composerForm"
      (ngSubmit)="send()"
    >
      <label class="sr-only" [attr.for]="domIds.COMPOSER_INPUT">
        {{ UI_TEXT.A11Y.MESSAGE_INPUT_LABEL }}
      </label>

      <input
        matInput
        class="app-input feature-chat__composer-input"
        type="text"
        autocomplete="off"
        [id]="domIds.COMPOSER_INPUT"
        [attr.maxlength]="config.MAX_MSG_LENGTH"
        [placeholder]="UI_TEXT.CHAT.INPUT_PLACEHOLDER"
        [attr.aria-invalid]="
          composerForm.controls.content.touched &&
          composerForm.controls.content.invalid
        "
        [attr.aria-describedby]="
          composerForm.controls.content.touched &&
          composerForm.controls.content.invalid
            ? domIds.COMPOSER_ERROR
            : null
        "
        [formControl]="composerForm.controls.content"
      />

      <button
        class="app-btn app-btn--primary feature-chat__composer-btn"
        type="submit"
        [disabled]="composerForm.invalid || !chatStore.hasNickname()"
        [attr.aria-label]="UI_TEXT.CHAT.SEND_BUTTON"
        [title]="UI_TEXT.CHAT.SEND_BUTTON"
      >
        <mat-icon aria-hidden="true">send</mat-icon>
      </button>
    </form>

    @if (composerForm.controls.content.touched &&
    composerForm.controls.content.hasError('required')) {
    <div
      class="feature-chat__error feature-chat__error--composer"
      [id]="domIds.COMPOSER_ERROR"
      role="alert"
    >
      {{ UI_TEXT.CHAT.ERROR_REQUIRED }}
    </div>
    }
  </div>
  }
</section>
