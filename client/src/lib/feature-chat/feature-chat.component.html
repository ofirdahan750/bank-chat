<section class="feature-chat">
  @if (!store.hasNickname()) {
    <div class="feature-chat__card surface" role="region" aria-label="Nickname">
      <header class="feature-chat__header">
        <h2 class="feature-chat__title">{{ uiText.LOGIN.TITLE }}</h2>
        <p class="feature-chat__subtitle">{{ uiText.LOGIN.SUBTITLE }}</p>
      </header>

      <form class="feature-chat__form" [formGroup]="nicknameForm" (ngSubmit)="submitNickname()">
        <input
          matInput
          class="app-input feature-chat__nickname-input"
          type="text"
          autocomplete="nickname"
          [attr.maxlength]="chatUi.USER.MAX_USERNAME_LENGTH"
          [placeholder]="uiText.LOGIN.INPUT_PLACEHOLDER"
          [formControl]="nicknameForm.controls.username"
        />

        @if (nicknameForm.controls.username.touched && nicknameForm.controls.username.hasError('required')) {
          <div class="feature-chat__error" role="alert">{{ uiText.LOGIN.ERROR_REQUIRED }}</div>
        } @else if (nicknameForm.controls.username.touched && nicknameForm.controls.username.hasError('minlength')) {
          <div class="feature-chat__error" role="alert">{{ uiText.LOGIN.ERROR_MIN_LENGTH }}</div>
        } @else if (nicknameForm.controls.username.touched && nicknameForm.controls.username.hasError('maxlength')) {
          <div class="feature-chat__error" role="alert">{{ uiText.LOGIN.ERROR_MAX_LENGTH }}</div>
        }

        <button
          class="app-btn app-btn--primary feature-chat__btn"
          type="submit"
          [disabled]="nicknameForm.invalid"
          [attr.aria-disabled]="nicknameForm.invalid"
        >
          {{ uiText.LOGIN.BUTTON }}
        </button>
      </form>
    </div>
  } @else {
    <div class="feature-chat__room surface" role="region" aria-label="Chat room">
      <header class="feature-chat__room-header">
        <div class="feature-chat__room-title">{{ store.username() }}</div>
        <div class="feature-chat__room-subtitle">{{ config.BOT_NAME }}</div>
      </header>

      <div class="feature-chat__messages" role="log" aria-live="polite" aria-relevant="additions">
        @if (store.messages().length === 0) {
          <div class="feature-chat__empty">
            <div>{{ uiText.CHAT.EMPTY_STATE }}</div>
          </div>
        } @else {
          @for (m of store.messages(); track trackById($index, m)) {
            <app-chat-bubble
              [message]="m"
              [meId]="store.me().id"
              [isMine]="m.sender.id === store.me().id && !m.sender.isBot"
              [canEdit]="m.sender.id === store.me().id && !m.sender.isBot"
              [timeLabel]="formatChatTime(m.timestamp)"
              (editSubmit)="onEditSubmit($event)"
              (reactionToggle)="onReactionToggle($event)"
            />
          }
        }
      </div>

      <form class="feature-chat__composer" [formGroup]="composerForm" (ngSubmit)="send()">
        <input
          matInput
          class="app-input feature-chat__composer-input"
          type="text"
          [attr.maxlength]="config.MAX_MSG_LENGTH"
          [placeholder]="uiText.CHAT.INPUT_PLACEHOLDER"
          [formControl]="composerForm.controls.content"
        />

        <button
          class="app-btn app-btn--primary feature-chat__composer-btn"
          type="submit"
          [disabled]="composerForm.invalid || !store.hasNickname()"
          [attr.aria-disabled]="composerForm.invalid || !store.hasNickname()"
        >
          <mat-icon aria-hidden="true">send</mat-icon>
        </button>
      </form>

      @if (composerForm.controls.content.touched && composerForm.controls.content.hasError('required')) {
        <div class="feature-chat__error feature-chat__error--composer" role="alert">
          {{ uiText.CHAT.ERROR_REQUIRED }}
        </div>
      }
    </div>
  }
</section>
